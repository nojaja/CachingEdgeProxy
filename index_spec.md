# CachingEdgeProxy 技術仕様書

## 概要

CachingEdgeProxyは、インターネット接続を高速化するためのキャッシュ機能付きプロキシサーバーです。一度アクセスしたウェブサイトのコンテンツをローカルに保存（キャッシュ）し、次回以降のアクセスを高速化します。Node.jsで実装されており、HTTPとHTTPSの両方のプロトコルに対応しています。

## 主な機能

1. **HTTPとHTTPSのプロキシ**: 通常のウェブページ（HTTP）と暗号化されたウェブページ（HTTPS）の両方に対応
2. **スマートキャッシュ**: あらかじめ設定したウェブサイトの内容をキャッシュ（MD5ハッシュを用いたキー管理）
3. **ホワイトリスト機能**: 正規表現にも対応したホワイトリスト設定によるキャッシュ対象ドメインの指定
4. **証明書管理**: HTTPSサイトへの接続に必要なTLS証明書を自動生成・管理
5. **クエリパラメータに対応したキャッシュ**: URLのクエリパラメータも含めた完全なキャッシュ
6. **接続の効率化**: Keep-Aliveやパイプライン処理によるパフォーマンスの最適化
7. **エラーハンドリング**: 様々な接続エラーに対応した堅牢なエラー処理

## 技術アーキテクチャ

### 1. プロキシサーバーの実装

Node.jsの標準ライブラリ（`http`, `https`, `net`, `tls`）を活用した非同期イベント駆動型プロキシサーバー。`http.createServer()`と`net.connect()`を組み合わせて、HTTP(S)リクエストの中継と処理を実装しています。

### 2. キャッシュシステム

ファイルシステムベースのキャッシュを実装しており、URLごとにMD5ハッシュを生成してユニークなキャッシュファイルを作成します。キャッシュデータはJSONフォーマットのメタデータファイルと実際のコンテンツファイルに分けて保存され、効率的な管理と読み込みを実現しています。

### 3. ホワイトリスト機能

設定ファイルで指定されたドメイン名を文字列完全一致または正規表現パターンでチェックし、キャッシュ対象を限定します。正規表現パターンは`regex:`プレフィックスで区別されます。

### 4. HTTP/HTTPS対応

- **HTTP**: 標準的なプロキシ処理で、リクエストとレスポンスの中継を行います。
- **HTTPS**: CONNECTメソッドのハンドリングとTLSトンネリングを実装。オプションでMITM（Man-in-the-Middle）方式のTLS終端処理によりHTTPSコンテンツもキャッシュ可能です。

## ソースコード構成と主要クラス/関数

### index.js

プログラムのエントリーポイントとメインロジックを含むファイルです。

#### 主要コンポーネント:

1. **サーバー初期化**
   - `http.createServer()`: HTTPプロキシサーバーのインスタンス生成
   - `server.on('connect')`: HTTPSトンネリングの処理
   - `initializeCacheDir()`: キャッシュディレクトリの初期化

2. **リクエスト処理**
   - `handleProxyRequest()`: リクエスト転送と処理
   - `setupHttpsResponseCapture()`: HTTPSレスポンスのキャプチャとキャッシュ
   - `directHttpsRequest()`: 直接HTTPSリクエストの実行

3. **キャッシュ管理**
   - `getCacheFileName()`: キャッシュファイル名の生成（URLからMD5ハッシュ）
   - `loadCache()`: キャッシュからのデータロード
   - `saveCache()`: キャッシュへのデータ保存

4. **その他のユーティリティ**
   - `isHostWhitelisted()`: ホワイトリストチェック
   - `normalizeUrl()`: URL正規化
   - `prefetchDomainContent()`: ドメインコンテンツの事前キャッシュ
   - `cleanup()`: アプリケーション終了時のクリーンアップ処理

### certificates.js

HTTPS接続に必要なTLS証明書を管理するクラスを実装しています。

#### 主な機能:

```javascript
class CertificateManager {
  constructor(config) { /* 設定の初期化 */ }
  async initialize() { /* 証明書の初期化・生成 */ }
  generateCertificate() { /* 新規証明書の生成 */ }
  getCertificate() { /* 証明書の取得 */ }
  getPrivateKey() { /* 秘密鍵の取得 */ }
}
```

- **証明書生成**: OpenSSL相当の機能をNode.js内で実装し、自己署名証明書を生成
- **証明書と鍵の管理**: ファイルシステムでの保存と読み込み

### テスト実装

#### e2e/proxy.curl.test.js

実際のネットワークリクエストを使用したEnd-to-Endテストを実装。

- `curl`コマンドをJestテストフレームワークから実行
- HTTP/HTTPSリクエストのプロキシング検証
- キャッシュヒット/ミスの確認
- エラー処理のテスト

#### certificates.test.js

証明書管理クラスの単体テスト。

- 証明書生成のテスト
- ファイル操作の検証
- エラー処理の確認

## データフロー
クライアント → [HTTP(S)リクエスト] → CachingEdgeProxy
  ↓
ホワイトリストチェック
  ↓
キャッシュチェック → [キャッシュヒット] → クライアントへレスポンス
  ↓ [キャッシュミス]
対象サーバーへリクエスト転送
  ↓
レスポンス受信
  ↓
ホワイトリスト対象の場合はキャッシュに保存
  ↓
クライアントへレスポンス転送

## 重要な実装詳細
非同期処理: Node.jsのPromiseとasync/await構文を使用した非同期処理
ストリーム処理: データの効率的な転送のためのストリームパイプライン
エラー処理: try-catchブロックとイベントリスナーによる包括的なエラーハンドリング
TLSの処理: 証明書管理とTLSソケット操作（自己署名証明書の生成・検証スキップ）
リソース管理: ソケットのクリーンアップとタイムアウト処理による安定性の向上
デバッグ機能: 複数レベルのロギングによるトラブルシューティングサポート

## 設定ファイル構造
```
{
  "proxyPort": 8000,
  "whitelistedDomains": [
    "example.com",
    "regex:^.*\\.mydomain\\.com$"
  ],
  "https": {
    "certPath": "path/to/certificate.crt",
    "keyPath": "path/to/private.key"
  }
}
```
## パフォーマンス最適化
1. バッファプーリング: メモリ使用量の最適化
2. 接続管理: Keep-Aliveとコネクションプーリング
3. 選択的キャッシュ: 重要なドメインのみをキャッシュしてストレージ効率化
4. エッジケースハンドリング: 様々なネットワーク状況や不安定な接続に対応

## セキュリティの考慮事項
1. TLS証明書管理: 自己署名証明書の安全な生成と保存
2. ホワイトリスト: 信頼できるドメインのみをキャッシュ
3. コネクション管理: タイムアウトと適切なソケットクローズによる資源枯渇防止
4. 入力検証: URLと受信データの適切な検証によるインジェクション防止

## まとめ
CachingEdgeProxyは、Node.jsの非同期イベント駆動モデルを活用した高性能なキャッシュプロキシサーバーです。
ファイルシステムベースのキャッシュとTLS終端によるHTTPSキャッシュを実装し、ホワイトリストによるドメイン制限機能を持っています。証明書の自動生成機能と堅牢なエラー処理により、安全性と安定性を両立させています。
